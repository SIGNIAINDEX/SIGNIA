{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://signia.dev/schemas/v1/manifest.json",
  "title": "SIGNIA Manifest v1",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "version",
    "bundle",
    "plugin",
    "inputs",
    "policies",
    "outputs",
    "hashes"
  ],
  "properties": {
    "version": {
      "type": "string",
      "const": "v1"
    },
    "bundle": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "bundleId",
        "createdAt",
        "format"
      ],
      "properties": {
        "bundleId": {
          "type": "string",
          "minLength": 8,
          "maxLength": 128,
          "description": "Opaque bundle id assigned by API or CLI. Not required for deterministic content-addressing but useful operationally."
        },
        "createdAt": {
          "type": "string",
          "format": "date-time",
          "description": "Creation time recorded by the tool. For strict determinism, tools may use a fixed epoch or omit from hashes by canonicalization domain separation rules."
        },
        "format": {
          "type": "string",
          "enum": [
            "dir",
            "zip"
          ]
        },
        "tool": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "name",
            "version"
          ],
          "properties": {
            "name": {
              "type": "string",
              "minLength": 1
            },
            "version": {
              "type": "string",
              "minLength": 1
            },
            "commit": {
              "type": "string"
            },
            "build": {
              "type": "string"
            }
          }
        }
      }
    },
    "plugin": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "id",
        "version"
      ],
      "properties": {
        "id": {
          "type": "string",
          "minLength": 1
        },
        "version": {
          "type": "string",
          "minLength": 1
        },
        "config": {
          "type": "object",
          "additionalProperties": true,
          "description": "Plugin config as provided by user; must be canonicalized before hashing."
        },
        "configHash": {
          "type": "string",
          "pattern": "^[0-9a-f]{64}$",
          "description": "Hash of canonicalized plugin config."
        }
      }
    },
    "inputs": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": [
          "kind",
          "locator",
          "bytes",
          "sha256"
        ],
        "properties": {
          "kind": {
            "type": "string",
            "enum": [
              "file",
              "archive",
              "url"
            ]
          },
          "locator": {
            "type": "string",
            "minLength": 1,
            "description": "Opaque locator; should not include absolute host paths."
          },
          "bytes": {
            "type": "integer",
            "minimum": 0
          },
          "sha256": {
            "type": "string",
            "pattern": "^[0-9a-f]{64}$"
          },
          "pinned": {
            "type": "boolean",
            "description": "True if remote input was pinned by checksum."
          }
        }
      }
    },
    "policies": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "normalization",
        "limits"
      ],
      "properties": {
        "normalization": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "policyVersion",
            "pathRoot",
            "newline",
            "encoding",
            "symlinks",
            "network"
          ],
          "properties": {
            "policyVersion": {
              "type": "string",
              "const": "v1"
            },
            "pathRoot": {
              "type": "string",
              "pattern": "^artifact:/$"
            },
            "newline": {
              "type": "string",
              "enum": [
                "lf"
              ]
            },
            "encoding": {
              "type": "string",
              "enum": [
                "utf-8"
              ]
            },
            "symlinks": {
              "type": "string",
              "enum": [
                "deny",
                "resolve-within-root"
              ]
            },
            "network": {
              "type": "string",
              "enum": [
                "deny",
                "allow-pinned-only"
              ]
            }
          }
        },
        "limits": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "maxTotalBytes",
            "maxFileBytes",
            "maxFiles",
            "maxDepth",
            "maxNodes",
            "maxEdges",
            "timeoutMs"
          ],
          "properties": {
            "maxTotalBytes": {
              "type": "integer",
              "minimum": 1
            },
            "maxFileBytes": {
              "type": "integer",
              "minimum": 1
            },
            "maxFiles": {
              "type": "integer",
              "minimum": 0
            },
            "maxDepth": {
              "type": "integer",
              "minimum": 0
            },
            "maxNodes": {
              "type": "integer",
              "minimum": 0
            },
            "maxEdges": {
              "type": "integer",
              "minimum": 0
            },
            "timeoutMs": {
              "type": "integer",
              "minimum": 1
            }
          }
        }
      }
    },
    "outputs": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "files",
        "stats"
      ],
      "properties": {
        "files": {
          "type": "array",
          "minItems": 1,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": [
              "path",
              "bytes",
              "sha256"
            ],
            "properties": {
              "path": {
                "type": "string",
                "minLength": 1,
                "description": "Relative path within bundle (e.g., schema.json)."
              },
              "bytes": {
                "type": "integer",
                "minimum": 0
              },
              "sha256": {
                "type": "string",
                "pattern": "^[0-9a-f]{64}$"
              }
            }
          }
        },
        "stats": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "entities",
            "edges"
          ],
          "properties": {
            "entities": {
              "type": "integer",
              "minimum": 0
            },
            "edges": {
              "type": "integer",
              "minimum": 0
            },
            "warnings": {
              "type": "integer",
              "minimum": 0
            }
          }
        }
      }
    },
    "hashes": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "schemaHash",
        "manifestHash",
        "proofRoot"
      ],
      "properties": {
        "schemaHash": {
          "type": "string",
          "pattern": "^[0-9a-f]{64}$"
        },
        "manifestHash": {
          "type": "string",
          "pattern": "^[0-9a-f]{64}$"
        },
        "proofRoot": {
          "type": "string",
          "pattern": "^[0-9a-f]{64}$"
        },
        "hashAlg": {
          "type": "string",
          "enum": [
            "sha256",
            "blake3"
          ]
        },
        "domain": {
          "type": "string",
          "minLength": 1,
          "description": "Domain separation label for hashing per hashing spec."
        }
      }
    }
  }
}
